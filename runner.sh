#!/bin/bash

RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
NC='\033[0m' 

echo """

â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â€ƒâ€ƒâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘
â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â€ƒâ€ƒâ–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–‘
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â•šâ•â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â€ƒâ€ƒâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â•šâ•â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–‘
â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â€ƒâ€ƒâ–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â•šâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â€ƒâ€ƒâ–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â•šâ•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•â–‘â–‘â•šâ•â•â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â•â€ƒâ€ƒâ•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â•â•â•â•â•â–‘â•šâ•â•â•â•â•â–‘â–‘â•šâ•â•â•â•â•â–‘â–‘â•šâ•â•â•â•â•â•â–‘
"""

# Function to display a title
display_title() {
    title="$1"
    border=$(printf '%*s\n' "${COLUMNS:-$(tput cols)}" '' | tr ' ' '-')
    echo ""
    echo -e "$title"
    echo -e "${CYAN}$border"
}

# Function to execute a command and check its success
execute_command() {
    echo -e "${YELLOW}Executing: $1...${NC}"
    bash -c "$1" &> /dev/null
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Success${NC}"
    else
        echo -e "${RED}Error occurred during execution. Exiting...${NC}"
        exit 1
    fi
}

# Check if the script is run as root
display_title "ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡­â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡°â€‹â€‹â€‹â€‹â€‹ ğŸ‡® â€‹â€‹â€‹â€‹â€‹ğŸ‡³ â€‹â€‹â€‹â€‹â€‹ğŸ‡¬â€‹â€‹â€‹â€‹â€‹  ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡½â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡º â€‹â€‹â€‹â€‹â€‹ğŸ‡¹ â€‹â€‹â€‹â€‹â€‹ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡´â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹  ğŸ‡µ â€‹â€‹â€‹â€‹â€‹ğŸ‡·â€‹â€‹â€‹â€‹â€‹ ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡»â€‹â€‹â€‹â€‹â€‹ ğŸ‡® â€‹â€‹â€‹â€‹â€‹ğŸ‡± â€‹â€‹â€‹â€‹â€‹ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡¬ â€‹â€‹â€‹â€‹â€‹ğŸ‡ª â€‹â€‹â€‹â€‹â€‹ğŸ‡¸â€‹â€‹â€‹â€‹â€‹"
if [ "$(id -u)" != "0" ]; then
    echo -e "${RED}Error: This script must be run as root. Use 'sudo ./runner.sh'.${NC}"
    exit 1
else
    echo -e "${GREEN}Success${NC}"
fi

# Installing Docker
display_title "ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡¸â€‹â€‹â€‹â€‹â€‹ ğŸ‡¹â€‹â€‹â€‹â€‹â€‹ ğŸ‡¦â€‹â€‹â€‹â€‹â€‹ ğŸ‡±â€‹â€‹â€‹â€‹â€‹ ğŸ‡±â€‹â€‹â€‹â€‹â€‹ ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡¬â€‹â€‹â€‹â€‹â€‹  ğŸ‡©â€‹â€‹â€‹â€‹â€‹ ğŸ‡´â€‹â€‹â€‹â€‹â€‹ ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡°â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡·â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹"
execute_command "apt-get update"
execute_command "apt-get install -y docker.io"
execute_command "systemctl start docker.service"

# Installing ffmpeg
display_title "ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡¸â€‹â€‹â€‹â€‹â€‹ ğŸ‡¹â€‹â€‹â€‹â€‹â€‹ ğŸ‡¦â€‹â€‹â€‹â€‹â€‹ ğŸ‡±â€‹â€‹â€‹â€‹â€‹ ğŸ‡±â€‹â€‹â€‹â€‹â€‹ ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡¬â€‹â€‹â€‹â€‹â€‹  ğŸ‡«â€‹â€‹â€‹â€‹â€‹ ğŸ‡«â€‹â€‹â€‹â€‹â€‹ ğŸ‡²â€‹â€‹â€‹â€‹â€‹ ğŸ‡µâ€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡¬â€‹â€‹â€‹â€‹â€‹"
execute_command "apt-get install -y ffmpeg"

# Function to check for raw video devices
check_for_raw_video() {
    ffmpeg -f v4l2 -list_formats all -i "$1" 2>&1 | grep -q "Raw"
}

video_devices=()

# Discovering webcams
display_title "ğŸ‡©â€‹â€‹â€‹â€‹â€‹ ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡¸â€‹â€‹â€‹â€‹â€‹ ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡´â€‹â€‹â€‹â€‹â€‹ ğŸ‡»â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡·â€‹â€‹â€‹â€‹â€‹ ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡¬â€‹â€‹â€‹â€‹â€‹  ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡´â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡¹â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡©â€‹â€‹â€‹â€‹â€‹  ğŸ‡¼â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡§â€‹â€‹â€‹â€‹â€‹ ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡¦â€‹â€‹â€‹â€‹â€‹ ğŸ‡²â€‹â€‹â€‹â€‹â€‹ ğŸ‡¸â€‹â€‹â€‹â€‹â€‹"
echo -e "${YELLOW}Searching for connected webcams...${NC}"
for dev in /dev/video*; do
    if check_for_raw_video "$dev"; then
        echo -e "${BLUE}Raw video device found: $dev${NC}"
        video_devices+=("$dev") # Add device to array
    fi
done

# File to store webcam device numbers
webcam_devices_file="webcam_devices.txt"

# Write detected webcam device numbers to a file
echo -n "" > $webcam_devices_file
for dev in "${video_devices[@]}"; do
    echo "${dev##*/dev/video}" >> $webcam_devices_file
done

# Building Docker Image
display_title "ğŸ‡§â€‹â€‹â€‹â€‹â€‹ ğŸ‡ºâ€‹â€‹â€‹â€‹â€‹ ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡±â€‹â€‹â€‹â€‹â€‹ ğŸ‡©â€‹â€‹â€‹â€‹â€‹ ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡¬â€‹â€‹â€‹â€‹â€‹  ğŸ‡©â€‹â€‹â€‹â€‹â€‹ ğŸ‡´â€‹â€‹â€‹â€‹â€‹ ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡°â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡·â€‹â€‹â€‹â€‹â€‹  ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡²â€‹â€‹â€‹â€‹â€‹ ğŸ‡¦â€‹â€‹â€‹â€‹â€‹ ğŸ‡¬â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹"
execute_command "docker build -t face-recog:latest ."

# Constructing Docker Run Command
echo -e "${YELLOW}Preparing to run the Docker container...${NC}"
docker_run_command="docker run"
for dev in "${video_devices[@]}"; do
    docker_run_command+=" --device=$dev:$dev"
done
docker_run_command+=" -e QT_QPA_PLATFORM=offscreen -it face-recog:latest"

# Running Docker Container
display_title "ğŸ‡·â€‹â€‹â€‹â€‹â€‹ ğŸ‡ºâ€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡¬â€‹â€‹â€‹â€‹â€‹  ğŸ‡©â€‹â€‹â€‹â€‹â€‹ ğŸ‡´â€‹â€‹â€‹â€‹â€‹ ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡°â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡·â€‹â€‹â€‹â€‹â€‹  ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ ğŸ‡´â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡¹â€‹â€‹â€‹â€‹â€‹ ğŸ‡¦â€‹â€‹â€‹â€‹â€‹ ğŸ‡®â€‹â€‹â€‹â€‹â€‹ ğŸ‡³â€‹â€‹â€‹â€‹â€‹ ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ ğŸ‡·â€‹â€‹â€‹â€‹â€‹"
echo -e "${YELLOW}Starting container...${NC}"
eval $docker_run_command
